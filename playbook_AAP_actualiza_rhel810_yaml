---
- name: Actualización del sistema operativo RHEL 8.x a RHEL 8.10 y reinicio automático si es necesario
  hosts: all
  gather_facts: true
  become: yes

  vars:
    log_file: "/tmp/actualizacion_rhel_{{ ansible_hostname }}_{{ ansible_date_time.date }}.log"

  tasks:
    - name: Iniciar registro de actualización
      copy:
        content: |
          ===== REGISTRO DE ACTUALIZACIÓN RHEL =====
          Host: {{ ansible_hostname }}
          Versión inicial: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Fecha inicio: {{ ansible_date_time.iso8601 }}
          ==========================================
        dest: "{{ log_file }}"
        mode: '0644'

    - name: Ejecutar actualización completa del sistema
      dnf:
        name: '*'
        state: latest
        update_cache: yes
      register: update_result
      async: 3600
      poll: 15

    - name: Registrar resultados de la actualización
      blockinfile:
        path: "{{ log_file }}"
        marker: "# {mark} ACTUALIZACIONES REALIZADAS #"
        block: |
          {{ update_result.stdout_lines | to_nice_yaml | indent(4) }}

    - name: Verificar si es necesario el reinicio
      shell: needs-restarting -r
      register: reboot_needed
      ignore_errors: yes
      changed_when: false

    - name: Informar si es necesario el reinicio
      debug:
        msg: "Reinicio necesario: {{ reboot_needed.stdout }}"

    - name: Reiniciar sistema si es necesario
      reboot:
        msg: "Reinicio por actualización del sistema"
        connect_timeout: 30
        reboot_timeout: 600
        pre_reboot_delay: 30
      when: reboot_needed.stdout is search("is required")

    - name: Esperar a que el sistema esté disponible
      wait_for_connection:
        delay: 10
        timeout: 300
      when: reboot_needed.stdout is search("is required")

    - name: Verificar versión final del sistema operativo
      command: cat /etc/redhat-release
      register: final_version
      changed_when: false

    - name: Registrar versión final del sistema operativo
      blockinfile:
        path: "{{ log_file }}"
        marker: "# {mark} RESULTADO FINAL #"
        block: |
          === ACTUALIZACIÓN COMPLETADA ===
          * Versión final: {{ final_version.stdout }}
          * Reinicio realizado: {{ 'Sí' if reboot_needed.stdout is search("is required") else 'No' }}
          * Hora finalización: {{ ansible_date_time.iso8601 }}

    - name: Verificar si la versión final es RHEL 8.10
      assert:
        that:
          - final_version.stdout is search("Red Hat Enterprise Linux release 8.10")
        msg: "La versión final no es RHEL 8.10"
