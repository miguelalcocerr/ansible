---
- name: Actualización automática a RHEL 8.10 con DNF
  hosts: all
  become: yes
  vars:
    target_release: "8.10"
    reboot_timeout: 600
    post_reboot_delay: 60
    # Configuración para confirmaciones automáticas
    auto_confirm: yes  # Cambiar a 'no' para confirmación manual
    dnf_confirmation: "-y"  # Flag -y para confirmación automática

  tasks:
    # 1. Configurar confirmación automática para DNF
    - name: Configurar entorno para confirmaciones automáticas
      ansible.builtin.set_fact:
        dnf_confirmation: "{{ 'y' if auto_confirm else '' }}"
      when: auto_confirm is defined

    # 2. Validar suscripción
    - name: Verificar estado de suscripción
      ansible.builtin.command: subscription-manager status
      register: sub_status
      changed_when: false
      ignore_errors: yes
      failed_when: sub_status.rc != 0

    # 3. Configurar versión objetivo
    - name: Establecer release objetivo
      ansible.builtin.command: |
        subscription-manager release --set {{ target_release }}
      register: release_set
      changed_when: "'Release set to' in release_set.stdout"
      args:
        stdin: "{{ dnf_confirmation }}"  # Envía confirmación automática

    # 4. Limpiar cache DNF
    - name: Limpiar cache de paquetes
      ansible.builtin.command: dnf clean all
      changed_when: false

    # 5. Actualización de paquetes base (automática)
    - name: Actualizar paquetes del sistema
      ansible.builtin.dnf:
        name: '*'
        state: latest
        exclude: kernel*, *-firmware
        update_cache: yes
        disable_gpg_check: no
        autoconfirm: "{{ auto_confirm }}"  # Confirmación automática
      register: base_update
      notify: Verificar reinicio

    # 6. Actualización del kernel (automática)
    - name: Actualizar kernel y firmware
      ansible.builtin.dnf:
        name: kernel*, *-firmware
        state: latest
        autoconfirm: "{{ auto_confirm }}"  # Confirmación automática
      when: base_update.changed
      register: kernel_update
      notify: Reinicio automático

    # 7. Post-verificación
    - name: Verificar estado final
      block:
        - name: Obtener versión del sistema
          ansible.builtin.command: cat /etc/redhat-release
          register: final_version
          changed_when: false

        - name: Verificar actualizaciones pendientes
          ansible.builtin.command: dnf check-update
          register: pending_updates
          ignore_errors: yes
          changed_when: false

        - name: Mostrar resumen ejecutivo
          ansible.builtin.debug:
            msg: |
              [RESULTADO FINAL]
              - Versión actual: {{ final_version.stdout }}
              - Actualizaciones aplicadas: {{ base_update.changed and kernel_update.changed | default(false) | ternary('Completas', 'Parciales') }}
              - Modo ejecución: {{ 'Automático' if auto_confirm else 'Manual' }}
              - Hora finalización: {{ ansible_date_time.iso8601 }}
      when: not ansible_check_mode

  handlers:
    # Handler para reinicio automático
    - name: Reinicio automático
      ansible.builtin.reboot:
        msg: "Reinicio automático iniciado"
        connect_timeout: 5
        reboot_timeout: "{{ reboot_timeout }}"
        pre_reboot_delay: 0  # Sin espera para modo automático
        post_reboot_delay: "{{ post_reboot_delay }}"
      listen: "Reinicio automático"
      when: 
        - kernel_update is defined 
        - kernel_update.changed
        - auto_confirm
